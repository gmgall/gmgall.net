<!DOCTYPE html>
<html lang="pt-br">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<style type=text/css>body{font-family:monospace;}</style>
	<title>Here Strings, Redirecionamentos e o builtin time</title>
	<meta name="description" content="O site pessoal de Guilherme Magalhães Gall, um trabalhador da área de TI. Contém textos técnicos sobre programação e os demais assuntos que interessam ao autor.">
	<meta name="author" content="Guilherme Magalhães Gall">
	<link rel="stylesheet" href="/css/style.css">
	<link rel="stylesheet" href="/css/blockquote.css?rnd=1674975722"><link rel="stylesheet" href="/css/old-content.css?rnd=1674975722">
	
</head>
<body>
	<header>
	================<br>
	== <a href="https://gmgall.net/">gmgall.net</a> ==<br>
	================
	<div style="float: right;">É de compreender que sobretudo nos cansamos. Viver é não pensar.</div><br>
	<p>
	<nav>
			<a href="/"><b>Início</b></a>.
			
			
			<a href="/blog/"><b>Blog</b></a>.
			
			<a href="/categories/"><b>Categorias</b></a>.
			
			<a href="/tags/"><b>Tags</b></a>.
			
			<a href="/books/"><b>Livros lidos</b></a>.
			
	</nav>
	</p>
	
</header>

	
	<main>
		<article>
			<h1>Here Strings, Redirecionamentos e o builtin time</h1>
			<b><time>28.01.2009 00:00</time></b>
		       
		           <a href="/tags/bash">bash</a>
           
		           <a href="/tags/shell-script">shell script</a>
           
		           <a href="/tags/shell">shell</a>
           

			<div>
        

  <div class="old-content">
    Esse conteúdo é antigo e pode estar desatualizado ou não representar mais a opinião do autor.
  </div>


				<p>Estou fazendo um comparativo entre <code>gzip</code> e <code>bzip2</code> em seus diferentes modos de compressão (-1 a -9) e para automatizar o processo fiz um script bash que usa alguns recursos bastante interessantes, mas às vezes negligenciados, por isso vou falar sobre eles aqui.</p>
<p>O script basicamente compacta um determinado arquivo com o <code>bzip2</code> e o <code>gzip</code>, cada um deles usando todos os modos de compressão, mede o tempo que o compactador ficou na CPU e escreve os resultados em um arquivo de saída. O comando para compactar o arquivo é montado dinamicamente usando dois loops aninhados. Um deles, o mais externo, itera sobre a lista de modos de compressão (-1 a -9) e o outro, o mais interno, itera sobre os compactadores. No final, a linha que realmente faz a compactação e mede o tempo gasto é</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>TIMEC<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>bc <span style="color:#f92672">&lt;&lt;&lt;</span> <span style="color:#66d9ef">$(</span><span style="color:#f92672">{</span> time eval <span style="color:#e6db74">&#34;</span>$CMDC<span style="color:#e6db74">&#34;</span>; <span style="color:#f92672">}</span> 2&gt;&amp;<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">))</span>
</span></span></code></pre></div><p>Onde <code>TIMEC</code> recebe o tempo de CPU gasto pelo comando de compactação e <code>$CMDC</code> contém o comando de compactação. Um valor que essa variável pode assumir durante a execução é <code>gzip -c -2 arquivo&gt;arquivo.gz</code>, por exemplo.</p>
<p>Feita essa introdução, o primeiro recurso interessante que eu gostaria de apresentar é o <em>here strings</em>. O funcionamento dele é simples. Dado um comando como:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bc <span style="color:#f92672">&lt;&lt;&lt;</span> <span style="color:#e6db74">&#39;1+1&#39;</span>
</span></span></code></pre></div><p>a string <code>1+1</code> será usada para alimentar a entrada padrão de <code>bc</code>. Isso substitui a forma tradicional</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>echo <span style="color:#e6db74">&#39;1+1&#39;</span> | bc
</span></span></code></pre></div><p>que faz a mesma coisa, mas força um <a href="https://en.wikipedia.org/wiki/Fork_(system_call)">fork</a> para isso, sendo mais ineficiente.</p>
<p>Na linha do script que citei no início do post, o <code>bc</code> vai receber o tempo gasto em modo usuário e o tempo gasto em modo kernel separados por um sinal de adição, fazendo portanto <code>TIMEC</code> receber a soma desses valores. Aqui chegamos no segundo recurso que gostaria de citar nesse post. O builtin <code>time</code> do bash (não confundir com o comando externo <code>time</code>), pode ter sua saída formatada através do conteúdo da variável <code>TIMEFORMAT</code>. Para fazer a saída do <code>time</code> ficar no formato de uma soma, simplesmente atribuí o valor <code>%U+%S</code> à <code>TIMEFORMAT</code>. O <code>%U</code> representa o tempo gasto em modo de usuário e o <code>%S</code> o tempo gasto em modo kernel.</p>
<p>Exemplo:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ time df
</span></span><span style="display:flex;"><span>Sist. Arq.           1K-blocos      Usad Dispon.   Uso% Montado em
</span></span><span style="display:flex;"><span>/dev/hdc3             <span style="color:#ae81ff">37491624</span>  <span style="color:#ae81ff">32393072</span>   <span style="color:#ae81ff">3194048</span>  92% /
</span></span><span style="display:flex;"><span>tmpfs                   <span style="color:#ae81ff">255180</span>         <span style="color:#ae81ff">0</span>    <span style="color:#ae81ff">255180</span>   0% /dev/shm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>real    0m0.061s
</span></span><span style="display:flex;"><span>user    0m0.020s
</span></span><span style="display:flex;"><span>sys     0m0.016s
</span></span><span style="display:flex;"><span>$ TIMEFORMAT<span style="color:#f92672">=</span>%U+%S <span style="color:#75715e"># Formatando a saída de time</span>
</span></span><span style="display:flex;"><span>$ time df
</span></span><span style="display:flex;"><span>Sist. Arq.           1K-blocos      Usad Dispon.   Uso% Montado em
</span></span><span style="display:flex;"><span>/dev/hdc3             <span style="color:#ae81ff">37491624</span>  <span style="color:#ae81ff">32393072</span>   <span style="color:#ae81ff">3194048</span>  92% /
</span></span><span style="display:flex;"><span>tmpfs                   <span style="color:#ae81ff">255180</span>         <span style="color:#ae81ff">0</span>    <span style="color:#ae81ff">255180</span>   0% /dev/shm
</span></span><span style="display:flex;"><span>0.020+0.008
</span></span></code></pre></div><p>Com isso, só fica faltando uma última coisa para mostrar: como redirecionar a saída do builtin <code>time</code>. A primeira coisa importante a ter em mente, é que os tempos medidos em si são jogados na <code>stderr</code>, enquanto que a <code>stdout</code> é usada para a saída do comando cujo tempo de execução é medido. Dito isso uma primeira tentativa de redirecionar a saída do <code>time</code> para um arquivo por exemplo, seria fazer simplesmente fazer algo como <code>time comando 2&gt; arquivo</code>, mas isso não funciona. O que é redirecionado para arquivo nesse caso é a saída de erros de comando, não a do time, que continua imprimindo na tela. Exemplo:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ time ls naoexiste 2&gt;saida_erros
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>real    0m0.041s
</span></span><span style="display:flex;"><span>user    0m0.036s
</span></span><span style="display:flex;"><span>sys     0m0.004s
</span></span><span style="display:flex;"><span>$ cat saida_erros
</span></span><span style="display:flex;"><span>ls: impossível acessar naoexiste: Arquivo ou diretório não encontrado
</span></span></code></pre></div><p>A saída para isso é executar o <code>time</code> dentro de um bloco (em uma subshell também funciona, mas é ineficiente) e redirecionar a saída de erros desse bloco. Exemplo:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ <span style="color:#f92672">{</span> time ls naoexiste 2&gt;/dev/null; <span style="color:#f92672">}</span> 2&gt;saida_erros
</span></span><span style="display:flex;"><span>$ cat saida_erros
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>real    0m0.056s
</span></span><span style="display:flex;"><span>user    0m0.028s
</span></span><span style="display:flex;"><span>sys     0m0.004s
</span></span></code></pre></div><p>Perceba que dentro do bloco eu redirecionei a saída de erros de <code>ls naoexiste</code> para <code>/dev/null</code>, para que ela não se misturasse com a saída do <code>time</code>.</p>
<p>Com isso já temos toda a teoria para entender a linha que citei no início do post. Vamos desmembrá-la e revisar o que apresentei nesse post.</p>
<h2 id="revisando">Revisando</h2>
<p>Na linha</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>TIMEC<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>bc <span style="color:#f92672">&lt;&lt;&lt;</span> <span style="color:#66d9ef">$(</span><span style="color:#f92672">{</span> time eval <span style="color:#e6db74">&#34;</span>$CMDC<span style="color:#e6db74">&#34;</span>; <span style="color:#f92672">}</span> 2&gt;&amp;<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">))</span>
</span></span></code></pre></div><p><code>TIMEC</code> vai receber a soma, feita pela calculadora <code>bc</code>, dos tempos calculados pelo builtin <code>time</code> do bash. A saída desse comando foi formatada de acordo com a variável <code>TIMEFORMAT</code> para formar uma string com uma soma do tempo gasto em modo kernel com o tempo gasto em modo de usuário (<code>%U+%S</code>).</p>
<p>Dentro da subshell cujo resultado alimenta a entrada padrão do <code>bc</code> o <code>time</code> precisou ser executado dentro de um bloco, para ser possível capturar o seu resultado, que vai para <code>stderr</code>. A <code>stdout</code> é usada para a saída do comando cujo tempo de execução é medido pelo <code>time</code>. A <code>stderr</code> do bloco inteiro foi conectado a <code>stdout</code>, sendo assim devidamente retornada pela subshell e usada para alimentar a entrada padrão da <code>bc</code> via <em>here strings</em>.</p>
<p>É isso. Quaisquer comentários são bem vindos.</p>
<h2 id="referências">Referências</h2>
<ul>
<li><a href="http://mywiki.wooledge.org/BashFAQ/032">BashFaq: How can I redirect the output of &rsquo;time&rsquo; to a variable or file?</a></li>
<li><a href="https://tldp.org/LDP/abs/html/io-redirection.html">Advanced Bash-Scripting Guide: I/O Redirection</a></li>
<li><a href="https://jneves.wordpress.com/2008/03/05/hello-world/">Papo de Botequim: Tira Gosto</a></li>
<li><a href="https://linux.die.net/man/1/bash">Manpage do Bash</a></li>
</ul>

			</div>
		</article>
	</main>
<aside>
	<div>
		<div>
			<h3>LATEST POSTS</h3>
		</div>
		<div>
			<ul>
				
				<li><a href="/blog/hello-world/">Hello World</a></li>
				
				<li><a href="/books/a-arte-de-pedir/">A Arte de Pedir</a></li>
				
				<li><a href="/books/engenheiros-do-caos/">Engenheiros do Caos</a></li>
				
				<li><a href="/books/sentido-da-vida/">C.S. Lewis, Richard Dawkins e o Sentido da Vida</a></li>
				
				<li><a href="/books/misto-quente/">Misto-Quente</a></li>
				
			</ul>
		</div>
	</div>
</aside>


	<footer>
	<p>&copy; 2023 <a href="https://gmgall.net/"><b>gmgall.net</b></a>.
	</p>
</footer>

</body>
</html>
