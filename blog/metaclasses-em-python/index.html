<!DOCTYPE html>
<html lang="pt-br">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<style type=text/css>body{font-family:monospace;}</style>
	<title>Metaclasses em Python</title>
	<meta name="description" content="O site pessoal de Guilherme Magalh√£es Gall, um trabalhador da √°rea de TI. Cont√©m textos t√©cnicos sobre programa√ß√£o e os demais assuntos que interessam ao autor.">
	<meta name="author" content="Guilherme Magalh√£es Gall">
	<meta name="generator" content="Hugo 0.109.0">
	<meta name="keywords" content="python, metaclasses, oo">
	<link rel="me" href="https://bolha.us/@gmgall">
	<link rel="stylesheet" href="/css/style.css">
	<link rel="stylesheet" href="/css/custom.css?rnd=1682119951">
	
</head>
<body>
	<header>
	================
	<div style="border-style: dotted; border-width: 2px; float: right">
	<label for="toggle-switch"><small>inverter tema</small></label>
	<input type="checkbox" id="toggle-switch">
	</div><br>
	== <a href="https://gmgall.net/">gmgall.net</a> ==<br>
	================
	<div style="float: right;">√â de compreender que sobretudo nos cansamos. Viver √© n√£o pensar.</div><br>
	<p>
	<nav>
			<a href="/"><b>In√≠cio</b></a>.
			
			
			<a href="/blog/"><b>Blog</b></a>.
			
			<a href="/categories/"><b>Categorias</b></a>.
			
			<a href="/tags/"><b>Tags</b></a>.
			
			<a href="/books/"><b>Livros lidos</b></a>.
			
			<a href="/feeds/"><b>Feeds üì°</b></a>.
			
			<a href="/contact/"><b><span class="highlighted-entry">Contato</span></b></a>.
			
	</nav>
	</p>
			
</header>

	
	<main>
		<article>
			<h1>Metaclasses em Python</h1>
			<b><time>21.02.2009 00:00</time></b>
				
					<a class="category-link" href="/categories/tech">tech</a>
				
				
					<a href="/tags/python">python</a>
				
					<a href="/tags/metaclasses">metaclasses</a>
				
					<a href="/tags/oo">oo</a>
				

			<div>
				

<div class="old-content">Esse conte√∫do √© antigo e pode estar desatualizado ou n√£o representar mais a opini√£o do autor.</div>


				<h2 id="introdu√ß√£o">Introdu√ß√£o</h2>
<p>Li dois textos interessantes no <a href="http://kodumaro.blogspot.com/">Kodumaro</a> recentemente: um sobre <a href="http://kodumaro.blogspot.com/2009/01/propriedades.html">propriedades e acessores</a> e outro sobre o <a href="http://kodumaro.blogspot.com/2009/01/s-ingleton.html">design pattern <em>singleton</em></a>. Ambos citavam as metaclasses, um conceito novo para mim e, pelo que andei conversando, novo para muitos de meus colegas de faculdade e trabalho. O seguinte texto √© resultado de minha tentativa de explicar o que s√£o metaclasses de uma forma simples de ser assimilada por pessoas que come√ßaram a estudar Python h√° pouco tempo como eu e portanto n√£o pode ser considerado como um guia definitivo e sem erros sobre o assunto. Qualquer sugest√£o ou coment√°rio √© bem vindo.</p>
<h2 id="revisando-orienta√ß√£o-a-objetos-e-definindo-metaclasses">Revisando Orienta√ß√£o a Objetos e definindo metaclasses</h2>
<p>Em uma linguagem de programa√ß√£o orientada a objetos, voc√™ pode definir classes que combinam dados (atributos) e m√©todos (comportamentos) que atuam sobre esses dados. Pode-se afirmar que ao definir uma classe se est√° definindo um dom√≠nio.</p>
<p>As classes geralmente atuam como modelos para a cria√ß√£o de inst√¢ncias de classe, que apesar de compartilharem uma mesma &ldquo;forma&rdquo;, possuem dados diferentes. Uma inst√¢ncia <code>real</code> e outra <code>peso</code> de uma mesma classe <code>Moeda</code> podem possuir um atributo <code>cotacao</code>, mas cada inst√¢ncia ter√° seu pr√≥prio valor para esse atributo.</p>
<p>Em Python, tudo √© objeto e tudo tem um tipo. N√£o existe diferen√ßa real entre uma classe e um tipo, especialmente depois da unifica√ß√£o de classes e tipos iniciada no Python 2.2. Ao definir uma classe, portanto, o programador est√° criando um novo tipo de dados. Como tudo √© objeto, as classes tamb√©m o s√£o e possuem uma classe, um tipo. A classe de uma classe √© chamada de metaclasse. O tipo <em>default</em> de uma classe √© <code>type</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Moeda</span>(object):
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>    <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> type(Moeda)
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span>type <span style="color:#e6db74">&#39;type&#39;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> Moeda
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">__main__</span><span style="color:#f92672">.</span>Moeda<span style="color:#e6db74">&#39;&gt;</span>
</span></span></code></pre></div><p>Ao chamar <code>type()</code> com apenas um argumento, obt√©m-se o tipo do objeto. Observe que o tipo da <strong>classe</strong> <code>Moeda</code> √© <code>type</code>. Afirmar que o tipo de uma classe √© <code>type</code> √© o mesmo que afirmar que a sua metaclasse √© <code>type</code>. O exemplo acima comprovou que as classes realmente s√£o um objeto com um tipo.</p>
<p>Os conceitos apresentados at√© aqui s√£o um tanto abstratos para quem aprendeu orienta√ß√£o a objetos em linguagens como Java e C# e para os novatos em Python. No t√≥pico seguinte, apresento a implementa√ß√£o de uma classe e de uma metaclasse com dicion√°rios, como se Python n√£o tivesse suporte sint√°tico para OO. Apesar de ningu√©m querer programar assim na pr√°tica o exemplo √© extremamente √∫til para entender como os objetos funcionam em Python.</p>
<h2 id="implementando-classes-com-dicion√°rios">Implementando classes com dicion√°rios</h2>
<p>O c√≥digo abaixo foi originalmente postado no blog de Pedro Werneck em um post que explicava o <a href="https://web.archive.org/web/20110812155307/http://diaspar.blogspot.com/2008/11/o-porqu-do-self-explcito-ser-que-agora.html">porqu√™ do <code>self</code> expl√≠cito</a>. Apesar de explicar metaclasses n√£o ser o objetivo principal do texto, achei bastante √∫til para entender como o suporte a orienta√ß√£o a objetos foi implementado em Python. Isso acaba levando ao entendimento de v√°rios conceitos interessantes (entre eles metaclasses) da linguagem e a uma aprecia√ß√£o ainda maior de sua simplicidade e consist√™ncia.</p>
<p>No post original, o c√≥digo evoluiu aos poucos at√© chegar ao ponto em que est√° aqui. Para um entendimento pleno, <a href="https://web.archive.org/web/20110812155307/http://diaspar.blogspot.com/2008/11/o-porqu-do-self-explcito-ser-que-agora.html">leia o post original</a>.</p>
<p>A primeira parte define uma fun√ß√£o <code>newClass</code> que recebe um nome de classe e um dicion√°rio com seus atributos e retorna um dicion√°rio que faz o papel das &ldquo;classes&rdquo; desse programa.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># precisaremos usar isso logo adiante...</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> functools <span style="color:#f92672">import</span> partial
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">### Agora j√° podemos pensar nela como a classe &#39;Class&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">newClass</span>(nome, atributos):
</span></span><span style="display:flex;"><span>    cls <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;nome&#39;</span>:nome} <span style="color:#75715e"># cria o dicion√°rio para a classe somente com seu nome</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> k, v <span style="color:#f92672">in</span> atributos<span style="color:#f92672">.</span>items():
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># aqui se um m√©todo for o newNome, ele tem de receber a mesma</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># altera√ß√£o e passar a receber &#39;cls&#39; como primeiro argumento</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> k <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;new&#39;</span><span style="color:#f92672">+</span>nome:
</span></span><span style="display:flex;"><span>            v <span style="color:#f92672">=</span> partial(v, cls)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># e atribu√≠mos tudo normalmente</span>
</span></span><span style="display:flex;"><span>        cls[k] <span style="color:#f92672">=</span> v
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> cls
</span></span></code></pre></div><p>Em seguida, √© definido uma &ldquo;classe&rdquo; <code>Pessoa</code> com os atributos <code>nome</code>, <code>nascimento</code> e um m√©todo <code>idade</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">### Classe Pessoa</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># construtor, corresponde ao __new__ de Python</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">newPessoa</span>(cls, nome, nascimento): <span style="color:#75715e"># agora a classe mesmo vem aqui</span>
</span></span><span style="display:flex;"><span>    inst <span style="color:#f92672">=</span> {} <span style="color:#75715e"># a nova inst√¢ncia</span>
</span></span><span style="display:flex;"><span>    inst[<span style="color:#e6db74">&#39;classe&#39;</span>] <span style="color:#f92672">=</span> cls <span style="color:#75715e"># a inst√¢ncia tem de saber de que classe √©, e</span>
</span></span><span style="display:flex;"><span>                         <span style="color:#75715e"># agora pode saber dinamicamente</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Agora a inst√¢ncia vai criar os m√©todos embrulhando as chamadas</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># para as fun√ß√µes originais em uma nova, j√° se incluindo nela</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> k, v <span style="color:#f92672">in</span> cls<span style="color:#f92672">.</span>items():
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Se for fun√ß√£o...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> callable(v):
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># √©, ent√£o vamos embrulhar...</span>
</span></span><span style="display:flex;"><span>            metodo <span style="color:#f92672">=</span> partial(v, inst)
</span></span><span style="display:flex;"><span>            inst[k] <span style="color:#f92672">=</span> metodo
</span></span><span style="display:flex;"><span>    inst[<span style="color:#e6db74">&#39;init&#39;</span><span style="color:#f92672">+</span>cls[<span style="color:#e6db74">&#39;nome&#39;</span>]](nome, nascimento)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> inst
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># inicializador, corresponde ao __init__ de Python</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">initPessoa</span>(inst, nome, nascimento):
</span></span><span style="display:flex;"><span>    inst[<span style="color:#e6db74">&#39;nome&#39;</span>] <span style="color:#f92672">=</span> nome
</span></span><span style="display:flex;"><span>    inst[<span style="color:#e6db74">&#39;nascimento&#39;</span>] <span style="color:#f92672">=</span> nascimento
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># assim como fazemos normalmente no __init__, aqui n√£o precisamos</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># nos preocupar</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">idade</span>(inst, hoje):
</span></span><span style="display:flex;"><span>    hd, hm, ha <span style="color:#f92672">=</span> hoje
</span></span><span style="display:flex;"><span>    nd, nm, na <span style="color:#f92672">=</span> inst[<span style="color:#e6db74">&#39;nascimento&#39;</span>]
</span></span><span style="display:flex;"><span>    x <span style="color:#f92672">=</span> ha <span style="color:#f92672">-</span> na
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> x
</span></span></code></pre></div><p>Com as fun√ß√µes que se tornar√£o os m√©todos da classe <code>Pessoa</code> definidos, falta a √∫ltima parte da defini√ß√£o da classe que √© criar o objeto que representa a classe. Esse objeto √© retornado pela fun√ß√£o <code>newClass</code> definida no in√≠cio do c√≥digo.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># e agora initPessoa() tem de entrar aqui tamb√©m</span>
</span></span><span style="display:flex;"><span>Pessoa <span style="color:#f92672">=</span> newClass(<span style="color:#e6db74">&#39;Pessoa&#39;</span>, {<span style="color:#e6db74">&#39;newPessoa&#39;</span>:newPessoa,
</span></span><span style="display:flex;"><span>                             <span style="color:#e6db74">&#39;initPessoa&#39;</span>:initPessoa,
</span></span><span style="display:flex;"><span>                             <span style="color:#e6db74">&#39;idade&#39;</span>:idade})
</span></span><span style="display:flex;"><span><span style="color:#75715e">### Fim da defini√ß√£o de classe</span>
</span></span></code></pre></div><p>A seguir, cria-se duas inst√¢ncias de <code>Pessoa</code> para testar a implementa√ß√£o.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>hank <span style="color:#f92672">=</span> Pessoa[<span style="color:#e6db74">&#39;newPessoa&#39;</span>](<span style="color:#e6db74">&#39;Hank Moody&#39;</span>, (<span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">11</span>, <span style="color:#ae81ff">1967</span>))
</span></span><span style="display:flex;"><span>print hank[<span style="color:#e6db74">&#39;idade&#39;</span>]((<span style="color:#ae81ff">6</span>, <span style="color:#ae81ff">11</span>, <span style="color:#ae81ff">2008</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>fante <span style="color:#f92672">=</span> Pessoa[<span style="color:#e6db74">&#39;newPessoa&#39;</span>](<span style="color:#e6db74">&#39;John Fante&#39;</span>, (<span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">1909</span>))
</span></span><span style="display:flex;"><span>print fante[<span style="color:#e6db74">&#39;idade&#39;</span>]((<span style="color:#ae81ff">6</span>, <span style="color:#ae81ff">11</span>, <span style="color:#ae81ff">2008</span>))
</span></span></code></pre></div><p>Nesse exemplo, a fun√ß√£o <code>newClass</code> faz o papel de uma metaclasse, pois √© ela que √© chamada para criar a classe. √â interessante notar que n√£o existe diferen√ßa real entre o funcionamento de <code>newClass</code> e <code>newPessoa</code>. Ambas s√£o fun√ß√µes que retornam inst√¢ncias, as inst√¢ncias retornadas por <code>newClass</code> s√£o &ldquo;classes&rdquo; e as inst√¢ncias retornadas por <code>newPessoa</code> s√£o objetos do tipo <code>Pessoa</code>.</p>
<p>O autor termina o texto usando as fun√ß√µes de inicializa√ß√£o e c√°lculo de idade com a metaclasse padr√£o de Python, <code>type</code>. Ela recebe uma string que ser√° o nome da nova classe, uma tupla de classes base e um dicion√°rio representando o <em>namespace</em> da classe. Esse dicion√°rio cont√©m o que voc√™ normalmente define como o corpo de uma instru√ß√£o <code>class</code>. A √∫nica coisa que tem que mudar √© o acesso aos atributos, que antes estavam sendo feitos como chaves de dicion√°rios e agora devem usar a sintaxe de atributos normais.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#-*- coding: utf-8 -*-</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">initPessoa</span>(inst, nome, nascimento):
</span></span><span style="display:flex;"><span>        inst<span style="color:#f92672">.</span>nome <span style="color:#f92672">=</span> nome
</span></span><span style="display:flex;"><span>        inst<span style="color:#f92672">.</span>nascimento <span style="color:#f92672">=</span> nascimento
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">idade</span>(inst, hoje):
</span></span><span style="display:flex;"><span>        hd, hm, ha <span style="color:#f92672">=</span> hoje
</span></span><span style="display:flex;"><span>        nd, nm, na <span style="color:#f92672">=</span> inst<span style="color:#f92672">.</span>nascimento
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> ha <span style="color:#f92672">-</span> na
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> x
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Pessoa <span style="color:#f92672">=</span> type(<span style="color:#e6db74">&#39;Pessoa&#39;</span>, (), {<span style="color:#e6db74">&#39;__init__&#39;</span>:initPessoa,
</span></span><span style="display:flex;"><span>                              <span style="color:#e6db74">&#39;idade&#39;</span>:idade})
</span></span><span style="display:flex;"><span>print <span style="color:#e6db74">&#34;Representa√ß√£o de Pessoa como string: &#34;</span>,Pessoa
</span></span><span style="display:flex;"><span>print <span style="color:#e6db74">&#34;Tipo de Pessoa (sua metaclasse): &#34;</span>,type(Pessoa)
</span></span><span style="display:flex;"><span>print
</span></span><span style="display:flex;"><span>print <span style="color:#e6db74">&#34;Imprimindo a idade de uma inst√¢ncia de Pessoa para teste: &#34;</span>
</span></span><span style="display:flex;"><span>hank <span style="color:#f92672">=</span> Pessoa(<span style="color:#e6db74">&#39;Hank Moody&#39;</span>, (<span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">11</span>, <span style="color:#ae81ff">1967</span>))
</span></span><span style="display:flex;"><span>print hank<span style="color:#f92672">.</span>idade((<span style="color:#ae81ff">6</span>, <span style="color:#ae81ff">11</span>, <span style="color:#ae81ff">2008</span>))
</span></span></code></pre></div><p>Resumindo:</p>
<ul>
<li>Em Python tudo √© objeto, inclusive classes e inst√¢ncias. N√£o existe diferen√ßa real entre elas.</li>
<li>Criar uma classe √© criar um novo tipo.</li>
<li>A classe de uma classe √© chamada de metaclasse. As inst√¢ncias de metaclasses s√£o classes.</li>
<li>A metaclasse <em>default</em> √© <code>type</code>.</li>
<li>N√£o existe diferen√ßa real entre m√©todos e fun√ß√µes. Os m√©todos s√£o apenas fun√ß√µes com <em>namespaces</em> espec√≠ficos (suas classes).</li>
</ul>
<h2 id="criando-e-definindo-metaclasses">Criando e definindo metaclasses</h2>
<p>Para definir sua pr√≥pria metaclasse, basta criar uma classe que herda da metaclasse <code>type</code>. O m√©todo inicializador recebe os mesmos argumentos que o m√©todo inicializador de <code>type</code>: uma string que ser√° o nome da classe, uma tupla de classes bases e um dicion√°rio representando o <em>namespace</em> da classe.</p>
<p>Segue um <a href="https://web.archive.org/web/20090215011047/http://www.ibm.com/developerworks/linux/library/l-pymeta.html">exemplo ligeiramente modificado</a> de um artigo do <a href="https://web.archive.org/web/20090221162632/http://www.ibm.com/developerworks/">IBM developerWorks</a>. Primeiramente, vamos definir uma nova metaclasse:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ChattyType</span>(type):
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>    <span style="color:#66d9ef">def</span> __new__(cls, name, bases, dct):
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>       print <span style="color:#e6db74">&#34;Alocando mem√≥ria para classe&#34;</span>, name
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>       dct[<span style="color:#e6db74">&#39;usa_metaclasse&#39;</span>]<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>       <span style="color:#66d9ef">return</span> type<span style="color:#f92672">.</span>__new__(cls, name, bases, dct)
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>    <span style="color:#66d9ef">def</span> __init__(cls, name, bases, dct):
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>       print <span style="color:#e6db74">&#34;Inicializando (configurando) classe&#34;</span>, name
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>       super(ChattyType, cls)<span style="color:#f92672">.</span>__init__(name, bases, dct)
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span></code></pre></div><p>Essa metaclasse sobrescreve o m√©todo <code>__new__</code> que efetivamente √© o construtor e retorna uma nova inst√¢ncia de classe (nesse exemplo espec√≠fico, a inst√¢ncia retornada ser√° uma classe por estarmos escrevendo uma <strong>meta</strong>classe) e o m√©todo <code>__init__</code> que √© o inicializador da inst√¢ncia e n√£o retorna nada. √â tentador chamar o <code>__init__</code> de construtor, mas o trabalho de cria√ß√£o de inst√¢ncias √© do <code>__new__</code>.</p>
<p>O c√≥digo acima criou um novo tipo que imprime uma mensagem quando est√° sendo criado e outra quando est√° sendo inicializado. Definiu-se tamb√©m que todas as inst√¢ncias do novo tipo ter√£o um atributo <code>usa_metaclasse</code> com o valor inicial <code>True</code>. Essa mudan√ßa foi feita adicionando uma chave ao dicion√°rio que representa o <em>namespace</em>  da classe (<code>dct</code>).</p>
<p>Com a metaclasse definida, j√° √© poss√≠vel criar classes a partir dela chamando-a como chama-se <code>type</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> X<span style="color:#f92672">=</span>ChattyType(<span style="color:#e6db74">&#39;X&#39;</span>, (object,), {})
</span></span><span style="display:flex;"><span>Alocando mem√≥ria para classe X
</span></span><span style="display:flex;"><span>Inicializando (configurando) classe X
</span></span></code></pre></div><p>Instanciar classes manualmente como feito acima, n√£o √© um procedimento muito comum. Segue como Python <a href="https://www.python.org/download/releases/2.2.3/descrintro/#metaclasses">determina a metaclasse</a> de uma determinada classe:</p>
<ol>
<li>
<p>Se o dicion√°rio que representa o <em>namespace</em> da classe contiver uma chave <code>__metaclass__</code>, o seu valor √© usado.</p>
</li>
<li>
<p>Sen√£o, se existe pelo menos uma classe base, sua metaclasse √© usada.</p>
</li>
<li>
<p>Sen√£o, se existe uma vari√°vel global <code>__metaclass__</code>, seu valor √© usado.</p>
</li>
<li>
<p>Sen√£o, <code>types.ClassType</code> √© usado.</p>
</li>
</ol>
<p>A cria√ß√£o da classe <code>X</code> feita no exemplo acima comumente seria feita assim:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">X</span>(object):
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>    __metaclass__<span style="color:#f92672">=</span>ChattyType
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>Alocando mem√≥ria para classe X
</span></span><span style="display:flex;"><span>Inicializando (configurando) classe X
</span></span></code></pre></div><p>A instancia√ß√£o de <code>ChattyType</code>, feita explicitamente no primeiro exemplo, agora √© feita pelo interpretador Python no final da instru√ß√£o <code>class</code>. Note que a instru√ß√£o <code>class</code> √© simplesmente <a href="https://en.wikipedia.org/wiki/Syntactic_sugar">a√ß√∫car sint√°tico</a> para a instancia√ß√£o de classes atrav√©s de suas metaclasses. Os programadores que n√£o fazem uso de metaclasses acabam n√£o percebendo isso, j√° que simplesmente criam suas classes usando <code>class</code> e Python simplesmente as instancia chamando <code>type</code>.</p>
<p>Continuando o exemplo, podemos confirmar que o tipo da classe √© a metaclasse:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> type(X)
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">__main__</span><span style="color:#f92672">.</span>ChattyType<span style="color:#e6db74">&#39;&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> y<span style="color:#f92672">=</span>X()
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> type(y)
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">__main__</span><span style="color:#f92672">.</span>X<span style="color:#e6db74">&#39;&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> type(X) <span style="color:#f92672">==</span> type(type(y))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">True</span>
</span></span></code></pre></div><p>Para concluir, segue algumas dicas na hora de usar metaclasses:</p>
<ul>
<li>
<p>A modifica√ß√£o do dicion√°rio que representa o <em>namespace</em> da classe deve ser feita em <code>__new__</code>, como no exemplo. Se na defini√ß√£o de <code>ChattyType</code>, <code>dct['usa_metaclasse']=True</code> fosse executado em <code>__init__</code>, a altera√ß√£o n√£o teria efeito. Considere o uso de <a href="https://docs.python.org/3/library/functions.html#setattr">setattr</a> nesses casos.</p>
</li>
<li>
<p>Sempre herde de <code>type</code>.</p>
</li>
<li>
<p><code>__new__</code> √© o construtor e deve retornar uma nova inst√¢ncia.</p>
</li>
<li>
<p>Erros em metaclasses costumam aparecer durante <code>import</code>s e defini√ß√µes de classes que usem metaclasses diferentes de <code>type</code>.</p>
</li>
</ul>
<h2 id="alguns-exemplos">Alguns exemplos</h2>
<p>Metaclasses s√£o usadas na maior parte do tempo para alterar o comportamento de cria√ß√£o e inicializa√ß√£o de classes. Na maioria dos casos, os usu√°rios finais s√£o outros programadores. Frameworks e ferramentas de mapeamento objeto-relacional s√£o exemplos de softwares que usam metaclasses.</p>
<p>Alguns usos para as metaclasses:</p>
<ul>
<li>
<p><a href="https://web.archive.org/web/20101122212629/http://www.python.org.br/wiki/UnificandoTiposClasses">Criar propriedades automaticamente</a></p>
</li>
<li>
<p><a href="http://kodumaro.blogspot.com/2009/01/s-ingleton.html">Usar o design pattern singleton de forma transparente</a></p>
</li>
<li>
<p><a href="https://everything2.com/title/metaclass">Monitorar todas as chamadas a m√©todos de uma classe</a></p>
</li>
<li>
<p><a href="https://web.archive.org/web/20090405120043/http://effbot.org/zone/metaclass-plugins.htm">Fazer plugins se registrarem automaticamente em um registro comum</a></p>
</li>
<li>
<p>Verificar diversos aspectos de uma classe para garantir que a classe tenha os m√©todos e atributos necess√°rios para o correto funcionamento do sistema. Isso √© interessante se a aplica√ß√£o pode ser estendida por plugins desenvolvidos por terceiros.</p>
</li>
</ul>
<p>O importante √© que a classe s√≥ √© realmente criada na chamada final a <code>type</code> na metaclasse. Voc√™ √© livre para modificar o dicion√°rio de atributos de acordo com as suas necessidades antes disso, portanto existem muito mais possibilidades de uso para as metaclasses do que as apresentadas aqui.</p>

			</div>
		</article>
	</main>
<aside>
	<div>
		<div>
			<h3>LATEST POSTS</h3>
		</div>
		<div>
			<ul>
				
				<li><a href="/blog/sobre-o-app-do-mastodon-e-discussoes-no-mastodon-em-geral/">Sobre o App do Mastodon e Discuss√µes no Mastodon em Geral</a></li>
				
				<li><a href="/blog/gerando-feeds-com-github-actions-e-os-servindo-com-github-pages/">Gerando Feeds Com GitHub Actions e os Servindo Com GitHub Pages</a></li>
				
				<li><a href="/blog/criando-feeds-rss-com-newslinkrss/">Criando Feeds RSS Para Sites Que N√£o os Fornecem</a></li>
				
				<li><a href="/blog/perguntas-idiotas/">Perguntas &#34;idiotas&#34; podem ser tentativas de ter controle sobre um mundo ca√≥tico</a></li>
				
				<li><a href="/books/um-homem-de-verdade/">Um Homem de Verdade</a></li>
				
			</ul>
		</div>
	</div>
</aside>


	<footer>
	<p><a href="/license">CC</a> 2023 <a href="https://gmgall.net/"><b>gmgall.net</b></a>.
	</p>
</footer>

</body>
<script src="/js/theme.js"></script>
</html>
