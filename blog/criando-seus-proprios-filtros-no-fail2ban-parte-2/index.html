<!DOCTYPE html>
<html lang="pt-br">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<style type=text/css>body{font-family:monospace;}</style>
	<title>Criando Seus Pr√≥prios Filtros no fail2ban - Parte 2</title>
	<meta name="description" content="O site pessoal de Guilherme Magalh√£es Gall, um trabalhador da √°rea de TI. Cont√©m textos t√©cnicos sobre programa√ß√£o e os demais assuntos que interessam ao autor.">
	<meta name="author" content="Guilherme Magalh√£es Gall">
	<meta name="generator" content="Hugo 0.109.0">
	<meta name="keywords" content="linux, sysadmin, fail2ban, debian">
	<link rel="me" href="https://bolha.us/@gmgall">
	<link rel="me" href="https://ursal.zone/@gmgall">
	<meta name="fediverse:creator" content="@gmgall@ursal.zone" />
	<link rel="stylesheet" href="/css/style.css">
	<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üë®‚Äçüíª</text></svg>">
	<link rel="stylesheet" href="/css/custom.css?rnd=1736898314">
	
</head>
<body>
	<header>
	================
	<div style="border-style: dotted; border-width: 2px; float: right">
	<label for="toggle-switch"><small>inverter tema</small></label>
	<input type="checkbox" id="toggle-switch">
	</div><br>
	== <a href="https://gmgall.net/">gmgall.net</a> ==<br>
	================
	<div style="float: right;">√â de compreender que sobretudo nos cansamos. Viver √© n√£o pensar.</div><br>
	<p>
	<nav>
			<a href="/"><b>In√≠cio</b></a>.
			
			
			<a href="/blog/"><b>Blog</b></a>.
			
			<a href="/categories/"><b>Categorias</b></a>.
			
			<a href="/tags/"><b>Tags</b></a>.
			
			<a href="/books/"><b>Livros lidos</b></a>.
			
			<a href="/feeds/"><b>Feeds üì°</b></a>.
			
			<a href="/blogroll/"><b>Blogroll</b></a>.
			
			<a href="/contact/"><b><span class="highlighted-entry">Contato</span></b></a>.
			
	</nav>
	</p>
			
</header>

	
	<main>
		<article>
			<h1>Criando Seus Pr√≥prios Filtros no fail2ban - Parte 2</h1>
			<b><time>01.08.2011 00:00</time></b>
				
					<a class="category-link" href="/categories/tech">tech</a>
				
				
					<a href="/tags/linux">linux</a>
				
					<a href="/tags/sysadmin">sysadmin</a>
				
					<a href="/tags/fail2ban">fail2ban</a>
				
					<a href="/tags/debian">debian</a>
				

			<div>
				

<div class="old-content">Esse conte√∫do √© antigo e pode estar desatualizado ou n√£o representar mais a opini√£o do autor.</div>


				<p>Se n√£o existe um filtro pronto para o log que voc√™ deseja monitorar em <code>filter.d</code>, ser√° necess√°rio criar seu pr√≥prio filtro. Mostrarei como fazer isso atrav√©s do exemplo que descrevo abaixo:</p>
<h2 id="cen√°rio-do-exemplo">Cen√°rio do exemplo</h2>
<p>Mantenho um wiki <a href="http://moinmo.in/">moinmoin</a> e desejo bloquear o acesso √† ele pelos hosts que tentarem login por mais de 3 vezes sem sucesso. Vamos fazer um filtro para fazer esse bloqueio. O log do wiki √© escrito em <code>/var/log/moinmoin.log</code>. Segue trecho desse log:</p>
<pre tabindex="0"><code>2011-07-12 15:45:40,447 MoinMoin.Page WARNING The page &#34;MissingPage&#34; could not be found. Check your underlay directory setting.
2011-07-12 15:45:44,002 MoinMoin.auth WARNING moin: performing login action | request from 192.168.0.10
2011-07-12 15:45:44,003 MoinMoin.auth WARNING moin: could not authenticate user u&#39;GuilhermeGall&#39; (not valid) | request from 192.168.0.10
2011-07-12 15:45:44,030 MoinMoin.Page WARNING The page &#34;MissingPage&#34; could not be found. Check your underlay directory setting.
2011-07-12 15:45:47,705 MoinMoin.auth WARNING moin: performing login action | request from 192.168.0.10
2011-07-12 15:45:47,706 MoinMoin.auth WARNING moin: could not authenticate user u&#39;GuilhermeGall&#39; (not valid) | request from 192.168.0.10
2011-07-12 15:45:47,732 MoinMoin.Page WARNING The page &#34;MissingPage&#34; could not be found. Check your underlay directory setting.
2011-07-12 15:55:59,473 MoinMoin.Page WARNING The page &#34;MissingPage&#34; could not be found. Check your underlay directory setting.
2011-07-12 16:08:51,543 MoinMoin.Page WARNING The page &#34;MissingPage&#34; could not be found. Check your underlay directory setting.
2011-07-13 09:09:01,908 MoinMoin.auth WARNING moin: performing login action | request from 192.168.0.7
</code></pre><p>N√£o √© dif√≠cil perceber que as linhas com <code>could not authenticate user u'GuilhermeGall' (not valid)</code> representam as tentativas de login malsucedidas. Se desejamos bloquear os hosts de origem dessas tentativas temos que fazer a regex do filtro casar essas linhas e usar o IP que aparece nelas para executar nossa a√ß√£o (por <em>default</em>, bloquear via <code>iptables</code>).</p>
<p>Antes de criar nosso filtro, vamos entender a estrutura de um filtro e como desenvolver nossas pr√≥prias regexes.</p>
<h2 id="estrutura-de-um-filtro">Estrutura de um filtro</h2>
<p>Um filtro √© simplesmente um arquivo com uma entrada <code>failregex</code>, que define as regexes que casam as linhas que representam as tentativas de login malsucedidas, e uma entrada <code>ignoreregex</code>, que define regexes que casam com linhas que devem ser ignoradas. Outras entradas podem existir, como <code>before</code> que faz um ‚Äúimport‚Äù de outro arquivo, mas <code>failregex</code> e <code>ignoreregex</code> s√£o as essenciais e usadas na maioria dos casos.</p>
<p>Se for definir mais de uma regex para <code>failregex</code> ou <code>ignoreregex</code>, coloque uma por linha. Exemplo do arquivo <code>filter.d/apache-auth.conf</code> que j√° vem no pacote <code>fail2ban</code>:</p>
<pre tabindex="0"><code>[Definition]

# Option:  failregex
# Notes.:  regex to match the password failure messages in the logfile. The
#          host must be matched by a group named &#34;host&#34;. The tag &#34;&lt;HOST&gt;&#34; can
#          be used for standard IP/hostname matching and is only an alias for
#          (?:::f{4,6}:)?(?P&lt;host&gt;[\w\-.^_]+)
# Values:  TEXT
#
failregex = [[]client &lt;HOST&gt;[]] user .* authentication failure
            [[]client &lt;HOST&gt;[]] user .* not found
            [[]client &lt;HOST&gt;[]] user .* password mismatch

# Option:  ignoreregex
# Notes.:  regex to ignore. If this regex matches, the line is ignored.
# Values:  TEXT
#
ignoreregex =
</code></pre><p>Conforme pode ser lido nos coment√°rios do arquivo acima, a tag <code>&lt;HOST&gt;</code> deve aparecer dentro da regex na posi√ß√£o onde aparece o IP/hostname do host ofensor. Repare que mais de uma regex foi definida para <code>failregex</code> ‚Äì uma em cada linha ‚Äì e que <code>ignoreregex</code> pode ser vazio.</p>
<h2 id="desenvolvendo-suas-pr√≥prias-regexes">Desenvolvendo suas pr√≥prias regexes</h2>
<p>Para escrever suas pr√≥prias regexes para o <code>fail2ban</code> √© preciso ter em mente o seguinte:</p>
<ul>
<li>
<p>Em toda linha de uma <code>failregex</code>, a parte que casa com o IP/hostname deve estar envolta pela estrutura <code>(?P&lt;host&gt; ... )</code>. Essa estrutura √© uma extens√£o espec√≠fica do Python que atribui o nome <code>&lt;host&gt;</code> ao que foi casado pelo grupo. A tag <code>&lt;host&gt;</code> √© como voc√™ informa ao <code>fail2ban</code> qual host estava tentando logar.</p>
</li>
<li>
<p>Como conveni√™ncia, √© poss√≠vel usar <code>&lt;HOST&gt;</code> nas suas regexes, conforme citei no t√≥pico anterior. <code>&lt;HOST&gt;</code> √© um alias para <code>(?:::f{4,6}:)?(?P&lt;host&gt;\S+)</code> que casa um IP/hostname dentro de um grupo chamado <code>&lt;host&gt;</code>. Vide item anterior.</p>
</li>
<li>
<p>Nas a√ß√µes, a tag <code>&lt;ip&gt;</code> ser√° substitu√≠da pelo IP do host casado pela tag <code>&lt;host&gt;</code>, por isso sempre deve existir um grupo nomeado <code>&lt;host&gt;</code>.</p>
</li>
<li>
<p>Para que uma linha de um log case com sua <code>failregex</code>, ela deve casar em duas partes: o in√≠cio da linha tem que casar com um padr√£o de <em>timestamp</em> e o restante da linha deve casar com a regex definida em <code>failregex</code>. Se sua <code>failregex</code> possui a √¢ncora <code>^</code>, ent√£o a √¢ncora refere-se ao in√≠cio do restante da linha, ap√≥s o <em>timestamp</em>.</p>
</li>
<li>
<p>Por √∫ltimo, mas n√£o menos importante, o comando <code>fail2ban-regex</code> permite testar suas regexes antes de criar o filtro. Na realidade, como escrever suas pr√≥prias regexes pode envolver alguma ‚Äì muita! ‚Äì tentativa e erro no come√ßo, eu diria que esse √© o item mais importante. üôÇ Ele pode ser usado de duas maneiras:</p>
</li>
</ul>
<pre tabindex="0"><code>fail2ban-regex /path/para/arquivo.log &#39;^regex a ser testada$&#39;
</code></pre><p>ou</p>
<pre tabindex="0"><code>fail2ban-regex &#39;linha exemplo de log&#39; &#39;^regex a ser testada$&#39;
</code></pre><h2 id="definindo-o-filtro">Definindo o filtro</h2>
<p>A regex que casa com as linhas que representam as tentativas de login malsucedidas √©:</p>
<pre tabindex="0"><code>MoinMoin\.auth (DEBUG|INFO|WARNING|ERROR|CRITICAL) moin: could not authenticate user .* \(not valid\) \| request from &lt;HOST&gt;$
</code></pre><p>N√£o √© do escopo desse artigo ensinar express√µes regulares. Tem muito <a href="https://aurelio.net/regex/">material bom sobre isso</a> por a√≠, mas resumindo a express√£o acima:</p>
<ul>
<li>
<p><code>MoinMoin\.auth</code> casa <code>MoinMoin.auth</code></p>
</li>
<li>
<p><code>DEBUG|INFO|WARNING|ERROR|CRITICAL)</code> casa <code>DEBUG</code>, <code>INFO</code>, <code>WARNING</code>, <code>ERROR</code> ou <code>CRITICAL</code>. Eu poderia ter casado apenas um dos n√≠veis de severidade, mas ainda estou decidindo em qual n√≠vel reportarei as mensagens referentes √† tentativas de login.</p>
</li>
<li>
<p><code>moin: could not authenticate user</code> casa <code>moin: could not authenticate user</code></p>
</li>
<li>
<p><code>.*</code> casa <em>qualquer caractere em qualquer quantidade</em></p>
</li>
<li>
<p><code>not valid\) \| request from</code> casa <code>(not valid) | request from</code></p>
</li>
<li>
<p><code>&lt;HOST&gt;</code> casa o <em>IP/hostname</em>. √â a tal tag indicativa de onde est√° o IP/hostname que √© substitu√≠da por <code>(?:::f{4,6}:)?(?P&lt;host&gt;\S+)</code></p>
</li>
<li>
<p><code>$</code> casa o <em>fim da linha</em></p>
</li>
</ul>
<p>Testando uma linha de exemplo do log com o <code>fail2ban-regex</code>:</p>
<pre tabindex="0"><code>$ fail2ban-regex &#39;2011-07-18 14:24:42,687 MoinMoin.auth WARNING moin: could not authenticate user u&#39;UserName&#39; (not valid) | request from 192.168.0.27&#39; &#39;MoinMoin\.auth (DEBUG|INFO|WARNING|ERROR|CRITICAL) moin: could not authenticate user .* \(not valid\) \| request from &lt;HOST&gt;$&#39;

Running tests
=============

Use regex line : MoinMoin\.auth (DEBUG|INFO|WARNING|ERROR|CRITICAL)...
Use single line: 2011-07-18 14:24:42,687 MoinMoin.auth WARNING moin...

Results
=======

Failregex
|- Regular expressions:
|  [1] MoinMoin\.auth (DEBUG|INFO|WARNING|ERROR|CRITICAL) moin: could not authenticate user .* \(not valid\) \| request from &lt;HOST&gt;$
|
`- Number of matches:
   [1] 1 match(es)

Ignoreregex
|- Regular expressions:
|
`- Number of matches:

Summary
=======

Addresses found:
[1]
    192.168.0.27 (Mon Jul 18 14:24:42 2011)

Date template hits:
0 hit(s): MONTH Day Hour:Minute:Second
0 hit(s): WEEKDAY MONTH Day Hour:Minute:Second Year
0 hit(s): WEEKDAY MONTH Day Hour:Minute:Second
0 hit(s): Year/Month/Day Hour:Minute:Second
0 hit(s): Day/Month/Year Hour:Minute:Second
0 hit(s): Day/Month/Year Hour:Minute:Second
0 hit(s): Day/MONTH/Year:Hour:Minute:Second
0 hit(s): Month/Day/Year:Hour:Minute:Second
2 hit(s): Year-Month-Day Hour:Minute:Second
0 hit(s): Day-MONTH-Year Hour:Minute:Second[.Millisecond]
0 hit(s): Day-Month-Year Hour:Minute:Second
0 hit(s): TAI64N
0 hit(s): Epoch
0 hit(s): ISO 8601
0 hit(s): Hour:Minute:Second
0 hit(s): 

Success, the total number of match is 1

However, look at the above section &#39;Running tests&#39; which could contain important
information.
</code></pre><p>Perceba que o comando mostrou a regex e o n√∫mero de casamentos, al√©m do IP encontrado abaixo de &ldquo;Addresses found&rdquo;, indicando que a regex est√° correta. O n√∫mero de casamentos presumivelmente seria maior que 1, se o comando fosse executado contra um arquivo de log ao inv√©s de apenas contra uma linha de exemplo.</p>
<p>Vamos supor voc√™ tenha cometido um erro, como por exemplo n√£o especificar um grupo chamado <code>host</code> na sua regex:</p>
<pre tabindex="0"><code>$ fail2ban-regex &#39;2011-07-18 14:24:42,687 MoinMoin.auth WARNING moin: could not authenticate user u&#39;UserName&#39; (not valid) | request from 192.168.0.27&#39; &#39;MoinMoin\.auth (DEBUG|INFO|WARNING|ERROR|CRITICAL) moin: could not authenticate user .* \(not valid\) \| request from$&#39;

Running tests
=============

Use regex line : MoinMoin\.auth (DEBUG|INFO|WARNING|ERROR|CRITICAL)...
Use single line: 2011-07-18 14:24:42,687 MoinMoin.auth WARNING moin...

No &#39;host&#39; group in &#39;MoinMoin\.auth (DEBUG|INFO|WARNING|ERROR|CRITICAL) moin: could not authenticate user .* \(not valid\) \| request from$&#39;
Cannot remove regular expression. Index 0 is not valid

Results
=======

Failregex
|- Regular expressions:
|  [1] MoinMoin\.auth (DEBUG|INFO|WARNING|ERROR|CRITICAL) moin: could not authenticate user .* \(not valid\) \| request from$
|
`- Number of matches:
   [1] 0 match(es)

Ignoreregex
|- Regular expressions:
|
`- Number of matches:

Summary
=======

Sorry, no match

Look at the above section &#39;Running tests&#39; which could contain important
information.
</code></pre><p>Perceba que o <code>fail2ban-regex</code> informa o erro <code>No 'host' group in...</code></p>
<p>Como j√° temos a regex funcional, crie um arquivo com o nome do filtro em <code>filter.d</code>:</p>
<pre tabindex="0"><code># cd /etc/fail2ban/
# cat filter.d/moinmoin.conf
[Definition]

# Option:  failregex
# Notes.:  regex to match the password failures messages in the logfile. The
#          host must be matched by a group named &#34;host&#34;. The tag &#34;&lt;HOST&gt;&#34; can
#          be used for standard IP/hostname matching and is only an alias for
#          (?:::f{4,6}:)?(?P&lt;host&gt;[\w\-.^_]+)
# Values:  TEXT
#
failregex = MoinMoin.auth (DEBUG|INFO|WARNING|ERROR|CRITICAL) moin: could not authenticate user .* \(not valid\) \| request from &lt;HOST&gt;$

# Option:  ignoreregex
# Notes.:  regex to ignore. If this regex matches, the line is ignored.
# Values:  TEXT
#
ignoreregex =
</code></pre><p>Crie uma <em>jail</em> que usa o filtro rec√©m-criado em <code>jail.local</code>:</p>
<pre tabindex="0"><code>[moinmoin]

enabled = true
port = 80
filter = moinmoin
logpath = /var/log/moinmoin.log
maxretry = 3
</code></pre><p>A vari√°vel <code>filter</code> define o nome do filtro, que √© o nome do arquivo criado em <code>filter.d</code> sem a extens√£o <code>.conf</code>.</p>
<p>Reinicie o <code>fail2ban</code> para ativar a nova <em>jail</em>:</p>
<pre tabindex="0"><code># /etc/init.d/fail2ban restart
</code></pre><p>√â interessante monitorar o log do pr√≥prio <code>fail2ban</code>, que por padr√£o fica em <code>/var/log/fail2ban.log</code>, para verificar se suas altera√ß√µes foram aplicadas com sucesso:</p>
<pre tabindex="0"><code># tail -f /var/log/fail2ban.log
2011-08-01 09:52:04,994 fail2ban.filter : INFO   Set findtime = 600
2011-08-01 09:52:04,994 fail2ban.actions: INFO   Set banTime = 600
2011-08-01 09:52:04,999 fail2ban.jail   : INFO   Creating new jail &#39;ssh&#39;
2011-08-01 09:52:04,999 fail2ban.jail   : INFO   Jail &#39;ssh&#39; uses poller
2011-08-01 09:52:05,000 fail2ban.filter : INFO   Added logfile = /var/log/auth.log
2011-08-01 09:52:05,001 fail2ban.filter : INFO   Set maxRetry = 3
2011-08-01 09:52:05,002 fail2ban.filter : INFO   Set findtime = 600
2011-08-01 09:52:05,002 fail2ban.actions: INFO   Set banTime = 600
2011-08-01 09:52:05,035 fail2ban.jail   : INFO   Jail &#39;moinmoin&#39; started
2011-08-01 09:52:05,039 fail2ban.jail   : INFO   Jail &#39;ssh&#39; started
</code></pre><p>As duas √∫ltimas linhas nos mostra as <em>jails</em> iniciadas. A <code>ssh</code>, que j√° vem configurada, e a <code>moinmoin</code>, que acabamos de configurar.</p>

			</div>
		</article>
	</main>





<aside>
	<div>
		<div>
			<h3>LATEST POSTS</h3>
		</div>
		<div>
			<ul>
				
				<li><a href="/blog/2-anos-de-site/">2 Anos de Site</a></li>
				
				<li><a href="/blog/free-software-advent-2024/">Free Software Advent 2024</a></li>
				
				<li><a href="/books/memorias-do-subsolo/">Mem√≥rias Do Subsolo</a></li>
				
				<li><a href="/blog/transcricao-thermidor/">Transcri√ß√£o dos Trechos em Letra Cursiva de &#39;Thermidor&#39;</a></li>
				
				<li><a href="/books/sandman-distant-mirrors/">Sandman - Distant Mirrors</a></li>
				
			</ul>
		</div>
	</div>
</aside>


	<footer>
	<p><a href="/license">CC</a> 2025 <a href="https://gmgall.net/"><b>gmgall.net</b></a>.
	</p>
</footer>

</body>
<script src="/js/theme.js"></script>
</html>
