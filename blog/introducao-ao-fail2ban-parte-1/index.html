<!DOCTYPE html>
<html lang="pt-br">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<style type=text/css>body{font-family:monospace;}</style>
	<title>Introdu√ß√£o ao fail2ban - Parte 1</title>
	<meta name="description" content="O site pessoal de Guilherme Magalh√£es Gall, um trabalhador da √°rea de TI. Cont√©m textos t√©cnicos sobre programa√ß√£o e os demais assuntos que interessam ao autor.">
	<meta name="author" content="Guilherme Magalh√£es Gall">
	<meta name="generator" content="Hugo 0.109.0">
	<meta name="keywords" content="linux, sysadmin, fail2ban, debian">
	<link rel="me" href="https://bolha.us/@gmgall">
	<link rel="stylesheet" href="/css/style.css">
	<link rel="stylesheet" href="/css/blockquote.css?rnd=1677792771"><link rel="stylesheet" href="/css/old-content.css?rnd=1677792771"><link rel="stylesheet" href="/css/theme.css?rnd=1677792771"><link rel="stylesheet" href="/css/highlighted-entry.css?rnd=1677792771">
	
</head>
<body>
	<header>
	================
	<div style="border-style: dotted; border-width: 2px; float: right">
	<label for="toggle-switch"><small>inverter tema</small></label>
	<input type="checkbox" id="toggle-switch">
	</div><br>
	== <a href="https://gmgall.net/">gmgall.net</a> ==<br>
	================
	<div style="float: right;">√â de compreender que sobretudo nos cansamos. Viver √© n√£o pensar.</div><br>
	<p>
	<nav>
			<a href="/"><b>In√≠cio</b></a>.
			
			
			<a href="/blog/"><b>Blog</b></a>.
			
			<a href="/categories/"><b>Categorias</b></a>.
			
			<a href="/tags/"><b>Tags</b></a>.
			
			<a href="/books/"><b>Livros lidos</b></a>.
			
			<a href="/feeds/"><b>Feeds üì°</b></a>.
			
			<a href="/contact/"><b><span class="highlighted-entry">Contato</span></b></a>.
			
	</nav>
	</p>
			
</header>

	
	<main>
		<article>
			<h1>Introdu√ß√£o ao fail2ban - Parte 1</h1>
			<b><time>29.07.2011 00:00</time></b>
				
					<a href="/tags/linux">linux</a>
				
					<a href="/tags/sysadmin">sysadmin</a>
				
					<a href="/tags/fail2ban">fail2ban</a>
				
					<a href="/tags/debian">debian</a>
				

			<div>
				

<div class="old-content">Esse conte√∫do √© antigo e pode estar desatualizado ou n√£o representar mais a opini√£o do autor.</div>


				<p>O fail2ban √© um software que monitora os logs do sistema e em caso de X (sendo X configur√°vel) tentativas de autentica√ß√£o sem sucesso em diversos servi√ßos toma uma atitude, que pode ser colocar o host ofensor em <code>/etc/hosts.deny</code>, &ldquo;dropar&rdquo; seus pacotes via <code>iptables</code> ou qualquer outra a√ß√£o definida pelo usu√°rio.</p>
<h2 id="instala√ß√£o-do-fail2ban">Instala√ß√£o do fail2ban</h2>
<p>Em m√°quinas Debian, a melhor maneira de instalar o <code>fail2ban</code> √© via <code>apt-get</code>:</p>
<pre tabindex="0"><code># apt-get update
# apt-get install fail2ban
</code></pre><p>As configura√ß√µes <em>default</em> bloqueiam via <code>iptables</code> por 10 minutos os hosts que tentarem sem sucesso login via ssh 6 vezes. O <code>fail2ban</code> cria uma <em>chain</em> com nome no padr√£o <code>fail2ban-servi√ßo</code>:</p>
<pre tabindex="0"><code># iptables -L
Chain INPUT (policy ACCEPT)
target prot opt source destination
fail2ban-ssh tcp -- anywhere anywhere multiport dports ssh

Chain FORWARD (policy ACCEPT)
target prot opt source destination

Chain OUTPUT (policy ACCEPT)
target prot opt source destination

Chain fail2ban-ssh (1 references)
target prot opt source destination
RETURN all -- anywhere anywhere
</code></pre><p>Lembrando que todo esse comportamento √© configur√°vel. O bloqueio pode ser feito via TCP-wrappers (<code>/etc/hosts.{allow,deny}</code>), e muitos outros servi√ßos s√£o suportados.</p>
<h2 id="entendendo-os-arquivos-de-configura√ß√£o">Entendendo os arquivos de configura√ß√£o</h2>
<p>Alguns termos usados pelo <code>fail2ban</code>:</p>
<ul>
<li>
<p><strong>filter</strong>: um filtro define uma regex que casa um padr√£o correspondente a uma tentativa de login mal sucedido nos arquivos de log;</p>
</li>
<li>
<p><strong>action</strong>: uma a√ß√£o define os comandos que s√£o executados nos mais diversos eventos, como bloquear um host (ex: bloquear via TCP-wrappers ou <code>iptables</code>), iniciar o <code>fail2ban</code> (ex: criar as chains no firewall) e parar o <code>fail2ban</code> (ex: remover as <em>chains</em> criadas ao iniciar);</p>
</li>
<li>
<p><strong>jail</strong>: uma <em>jail</em> √© uma combina√ß√£o de um filtro com uma ou v√°rias <em>actions</em>. O <code>fail2ban</code> pode lidar com diversas <em>jails</em> ao mesmo tempo.</p>
</li>
</ul>
<p>Uma <em>jail</em> √© como dar a seguinte ordem ao <code>fail2ban</code>: &ldquo;bloqueie via <code>iptables</code> por 10 minutos os hosts que aparecerem 3 vezes em <code>/var/log/auth.log</code> com falha de autentica√ß√£o&rdquo;. Nesse exemplo, bloquear via <code>iptables</code> √© uma a√ß√£o e a regex que casa a falha de autentica√ß√£o √© o filtro.</p>
<p>Os arquivos de configura√ß√£o ficam em <code>/etc/fail2ban</code>.</p>
<pre tabindex="0"><code># cd /etc/fail2ban
# ls -l
total 17
drwxr-xr-x 2 root root 1024 Jun 28 14:30 action.d
-rw-r--r-- 1 root root 859 Feb 27 2008 fail2ban.conf
drwxr-xr-x 2 root root 1024 Jun 28 14:30 filter.d
-rw-r--r-- 1 root root 6683 Jun 28 2010 jail.conf
</code></pre><p>Os diret√≥rios <code>action.d</code> e <code>filter.d</code> mant√™m as configura√ß√µes de a√ß√µes e filtros, respectivamente. Os que v√™m com o pacote j√° devem atender √† maior parte das necessidades. O arquivo <code>fail2ban.conf</code> cont√©m configura√ß√µes gerais do <em>daemon</em> <code>fail2ban-server</code>, como <em>path</em> do arquivo de <em>log</em> do <code>fail2ban</code>, <em>path</em> do arquivo socket usado para o cliente de linha de comando se comunicar com o <em>daemon</em> etc.</p>
<p>O arquivo <code>jail.conf</code> √© o mais importante, j√° que configura as <em>jails</em>. No t√≥pico abaixo ser√° explicado como modificar uma <em>jail</em>.</p>
<h2 id="mudando-as-configura√ß√µes-default">Mudando as configura√ß√µes default</h2>
<p>Na maior parte do tempo, os filtros e a√ß√µes que v√™m com o pacote atendem √†s necessidades, bastando us√°-los nas suas <em>jails</em>. A √∫nica <em>jail</em> que vem ativada por padr√£o √© a que bloqueia os hosts que tentarem logar mais de 6 vezes via SSH. Como exemplo, ser√° mostrado como alterar o n√∫mero de tentativas antes do bloqueio de 6 para 3.</p>
<p>Primeiramente crie uma c√≥pia do arquivo <code>jail.conf</code> chamada <code>jail.local</code> e fa√ßa as suas modifica√ß√µes nesse arquivo:</p>
<pre tabindex="0"><code># cp jail.conf jail.local
# vim jail.local
</code></pre><p>O trecho abaixo configura uma <em>jail</em> chamada <code>ssh</code></p>
<pre tabindex="0"><code>[ssh]

enabled = true
port = ssh
filter = sshd
logpath = /var/log/auth.log
maxretry = 6
</code></pre><p>Mude para:</p>
<pre tabindex="0"><code>[ssh]

enabled = true
port = ssh
filter = sshd
logpath = /var/log/auth.log
maxretry = 3
</code></pre><p>Fa√ßa o <code>fail2ban</code> reler os arquivos de configura√ß√£o:</p>
<pre tabindex="0"><code># /etc/init.d/fail2ban reload
Reloading authentication failure monitor: fail2ban.
</code></pre><p>N√£o fa√ßa as altera√ß√µes diretamente em <code>jail.conf</code>. Apesar de funcionar, o arquivo pode ser sobrescrito por atualiza√ß√µes no pacote <code>fail2ban</code>. O <code>fail2ban</code> aplica as regras primeiro do <code>jail.conf</code> depois do <code>jail.local</code>.</p>

			</div>
		</article>
	</main>
<aside>
	<div>
		<div>
			<h3>LATEST POSTS</h3>
		</div>
		<div>
			<ul>
				
				<li><a href="/books/tempo-e-dinheiro/">Tempo √© Dinheiro</a></li>
				
				<li><a href="/blog/acompanhando-suas-inscricoes-no-youtube-por-rss/">Acompanhando Suas Inscri√ß√µes no YouTube por RSS</a></li>
				
				<li><a href="/books/a-colheita/">A Colheita</a></li>
				
				<li><a href="/blog/tchau-twitter/">Tchau, Twitter</a></li>
				
				<li><a href="/blog/shortcodes-no-hugo-inserem-quebras-de-linha-indesejadas/">Shortcodes no Hugo Inserem Quebras de Linha Indesejadas</a></li>
				
			</ul>
		</div>
	</div>
</aside>


	<footer>
	<p><a href="/license">CC</a> 2023 <a href="https://gmgall.net/"><b>gmgall.net</b></a>.
	</p>
</footer>

</body>
<script src="/js/theme.js"></script>
</html>
