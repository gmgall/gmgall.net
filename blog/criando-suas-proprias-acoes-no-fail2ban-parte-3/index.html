<!DOCTYPE html>
<html lang="pt-br">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<style type=text/css>body{font-family:monospace;}</style>
	<title>Criando Suas Pr√≥prias A√ß√µes no fail2ban - Parte 3</title>
	<meta name="description" content="O site pessoal de Guilherme Magalh√£es Gall, um trabalhador da √°rea de TI. Cont√©m textos t√©cnicos sobre programa√ß√£o e os demais assuntos que interessam ao autor.">
	<meta name="author" content="Guilherme Magalh√£es Gall">
	<meta name="generator" content="Hugo 0.109.0">
	<meta name="keywords" content="linux, sysadmin, fail2ban, debian">
	<link rel="me" href="https://bolha.us/@gmgall">
	<link rel="me" href="https://ursal.zone/@gmgall">
	<link rel="stylesheet" href="/css/style.css">
	<link rel="stylesheet" href="/css/custom.css?rnd=1691699993">
	
</head>
<body>
	<header>
	================
	<div style="border-style: dotted; border-width: 2px; float: right">
	<label for="toggle-switch"><small>inverter tema</small></label>
	<input type="checkbox" id="toggle-switch">
	</div><br>
	== <a href="https://gmgall.net/">gmgall.net</a> ==<br>
	================
	<div style="float: right;">√â de compreender que sobretudo nos cansamos. Viver √© n√£o pensar.</div><br>
	<p>
	<nav>
			<a href="/"><b>In√≠cio</b></a>.
			
			
			<a href="/blog/"><b>Blog</b></a>.
			
			<a href="/categories/"><b>Categorias</b></a>.
			
			<a href="/tags/"><b>Tags</b></a>.
			
			<a href="/books/"><b>Livros lidos</b></a>.
			
			<a href="/feeds/"><b>Feeds üì°</b></a>.
			
			<a href="/contact/"><b><span class="highlighted-entry">Contato</span></b></a>.
			
	</nav>
	</p>
			
</header>

	
	<main>
		<article>
			<h1>Criando Suas Pr√≥prias A√ß√µes no fail2ban - Parte 3</h1>
			<b><time>04.08.2011 00:00</time></b>
				
					<a class="category-link" href="/categories/tech">tech</a>
				
				
					<a href="/tags/linux">linux</a>
				
					<a href="/tags/sysadmin">sysadmin</a>
				
					<a href="/tags/fail2ban">fail2ban</a>
				
					<a href="/tags/debian">debian</a>
				

			<div>
				

<div class="old-content">Esse conte√∫do √© antigo e pode estar desatualizado ou n√£o representar mais a opini√£o do autor.</div>


				<h2 id="estrutura-de-uma-a√ß√£o">Estrutura de uma a√ß√£o</h2>
<p>Cada a√ß√£o √© um arquivo no diret√≥rio <code>action.d</code>. Esses arquivos seguem a seguinte estrutura:</p>
<pre tabindex="0"><code>[Definition]

# Option:  actionstart
# Notes.:  comando executado ao iniciar o Fail2Ban.
# Values:  CMD
#
actionstart =


# Option:  actionstop
# Notes.:  comando executado ao encerrar o Fail2Ban
# Values:  CMD
#
actionstop =


# Option:  actioncheck
# Notes.:  comando executado antes de cada comando actionban
# Values:  CMD
#
actioncheck =


# Option:  actionban
# Notes.:  comando executado ao banir um IP. Observe que o comando
#          √© executado com as permiss√µes do usu√°rio executando o Fail2Ban.
# Tags:    &lt;ip&gt;  IP address
#          &lt;failures&gt;  number of failures
#          &lt;time&gt;  unix timestamp of the ban time
# Values:  CMD
#
actionban = ipfw add deny tcp from &lt;ip&gt; to &lt;localhost&gt; &lt;port&gt;


# Option:  actionunban
# Notes.:  comando executado ao &#34;desbanir&#34; um IP. Observe que o comando
#          √© executado com as permiss√µes do usu√°rio executando o Fail2Ban.
# Tags:    &lt;ip&gt;  IP address
#          &lt;failures&gt;  number of failures
#          &lt;time&gt;  unix timestamp of the ban time
# Values:  CMD
#
actionunban = ipfw delete `ipfw list | grep -i &lt;ip&gt; | awk &#39;{print $1;}&#39;`

[Init]

# Option:  port
# Notes.:  specifies port to monitor
# Values:  [ NUM | STRING ]
#
port = ssh

# Option:  localhost
# Notes.:  the local IP address of the network interface
# Values:  IP
#
localhost = 127.0.0.1
</code></pre><p>O arquivo que usei de exemplo acima j√° vem com o pacote e configura uma a√ß√£o que usa o ipfw para bloquear os IPs. Traduzi os coment√°rios da se√ß√£o <code>[Definition]</code> para explicar o que cada entrada define.</p>
<p>A se√ß√£o <code>[Init]</code> define &ldquo;vari√°veis&rdquo; que podem ser usadas ao longo do arquivo. Nesse exemplo, <code>port</code> e <code>localhost</code>, mas que vari√°veis definir √© por conta do usu√°rio. <strong>Lembrando que</strong> <code>&lt;ip&gt;</code> <strong>vira o IP/hostname casado no grupo</strong> <code>&lt;host&gt;</code> <strong>dos filtros</strong>.</p>
<h2 id="definindo-uma-a√ß√£o">Definindo uma a√ß√£o</h2>
<p>Existem a√ß√µes predefinidas que bloqueiam por <code>iptables</code>, <code>ipfw</code>, <code>shorewall</code>, TCP wrappers, que avisam por e-mail a cada bloqueio&hellip; Mas n√£o existe nenhuma que avise via Gtalk. Vamos criar uma a√ß√£o que faz isso.</p>
<p>Usarei o programa <a href="https://web.archive.org/web/20110827104139/http://sendxmpp.platon.sk/">sendxmpp</a> para definir uma a√ß√£o que enviar√° uma mensagem para mim no Gtalk a cada evento. Como configurar o sendxmpp para o Gtalk <a href="http://ubuntuforums.org/showpost.php?s=0ecf5b2a9c9a97fbfa5438c354dcfc2c&amp;p=8876182&amp;postcount=3">pode ser visto aqui</a>. Conheci o sendxmpp num <a href="http://eriberto.pro.br/blog/2011/03/02/mensagens-jabber-via-linha-de-comando-ideal-para-servidores-de-rede/">post</a> do <a href="http://eriberto.pro.br/blog/">blog</a> do <a href="http://eriberto.pro.br/site/">Jo√£o Eriberto Mota Filho</a> (<a href="https://twitter.com/eribertomota">@eribertomota</a>).</p>
<p>Vamos √† listagem do arquivo <code>action.d/gtalk.local</code>:</p>
<pre tabindex="0"><code>[Definition]

actionstart = printf %%b &#34;Hi,\n
              The jail &lt;name&gt; has been started successfully.\n
              Regards,\n
              Fail2Ban&#34;|sendxmpp -t -u &lt;from&gt; -o gmail.com 

actionstop = printf %%b &#34;Hi,\n
             The jail &lt;name&gt; has been stopped.\n
             Regards,\n
             Fail2Ban&#34;|sendxmpp -t -u &lt;from&gt; -o gmail.com 

actioncheck =

actionban = printf %%b &#34;Hi,\n
            The IP &lt;ip&gt; has just been banned by Fail2Ban after
            &lt;failures&gt; attempts against &lt;name&gt;.\n
            Regards,\n
            Fail2Ban&#34;|sendxmpp -t -u &lt;from&gt; -o gmail.com &lt;to&gt;

actionunban =

[Init]

name = default

from =

to =
</code></pre><p>Essa a√ß√£o enviar√° uma mensagem para o usu√°rio definido em <code>to</code> tendo como remetente o usu√°rio definido em <code>from</code> ao iniciar, parar e ao bloquear um IP.</p>
<h2 id="ativando-sua-a√ß√£o">Ativando sua a√ß√£o</h2>
<p>As a√ß√µes s√£o definidas por <em>jail</em> ou globalmente na se√ß√£o <code>[DEFAULT]</code> de <code>jail.local</code>. A√ß√µes definidas nas <em>jails</em> tem prioridade sobre as definidas globalmente.</p>
<p>Observe o seguinte trecho de <code>jail.local</code>:</p>
<pre tabindex="0"><code>#
# ACTIONS
#

# Default banning action (e.g. iptables, iptables-new,
# iptables-multiport, shorewall, etc) It is used to define
# action_* variables. Can be overriden globally or per
# section within jail.local file
banaction = iptables-multiport

# email action. Since 0.8.1 upstream fail2ban uses sendmail
# MTA for the mailing. Change mta configuration parameter to mail
# if you want to revert to conventional &#39;mail&#39;.
mta = sendmail

# Default protocol
protocol = tcp

#
# Action shortcuts. To be used to define action parameter

# The simplest action to take: ban only
action_ = %(banaction)s[name=%(__name__)s, port=&#34;%(port)s&#34;, protocol=&#34;%(protocol)s]

# ban &amp; send an e-mail with whois report to the destemail.
action_mw = %(banaction)s[name=%(__name__)s, port=&#34;%(port)s&#34;, protocol=&#34;%(protocol)s]
%(mta)s-whois[name=%(__name__)s, dest=&#34;%(destemail)s&#34;, protocol=&#34;%(protocol)s]

# ban &amp; send an e-mail with whois report and relevant log lines
# to the destemail.
action_mwl = %(banaction)s[name=%(__name__)s, port=&#34;%(port)s&#34;, protocol=&#34;%(protocol)s]
%(mta)s-whois-lines[name=%(__name__)s, dest=&#34;%(destemail)s&#34;, logpath=%(logpath)s]

# Choose default action. To change, just override value of &#39;action&#39; with the
# interpolation to the chosen action shortcut (e.g. action_mw, action_mwl, etc) in jail.local
# globally (section [DEFAULT]) or per specific section
action = %(action_)s
</code></pre><p>A vari√°vel <code>action</code> define a a√ß√£o globalmente. As outras vari√°veis definidas antes (<code>action_mvl</code>, <code>action_mw</code> e <code>action_</code>) s√£o atalhos √∫teis. Leia os coment√°rios com aten√ß√£o para entender como essas vari√°veis interagem.</p>
<p>Repare que mais de uma a√ß√£o pode ser setada por linha e que cada a√ß√£o pode receber par√¢metros entre colchetes. Esses par√¢metros definem os valores das vari√°veis declaradas na se√ß√£o <code>[Init]</code>. Os atalhos <code>action_mvl</code>, <code>action_mw</code> e <code>action_</code> s√£o √∫teis por j√° ativarem a√ß√µes e passarem par√¢metros funcionais para tarefas rotineiras como banir e enviar um e-mail com informa√ß√µes √∫teis.</p>
<p>Para definir nossa a√ß√£o gtalk globalmente, basta fazer</p>
<pre tabindex="0"><code>action = %(action_)s
        gtalk[name=%(__name__)s, from=gmgall, to=gmgall]
</code></pre><p>e recarregar as configura√ß√µes do servi√ßo:</p>
<pre tabindex="0"><code># /etc/init.d/fail2ban reload
</code></pre><p>Funciona!</p>
<figure><img src="screenshot.png"
         alt="Janela de chat do mensageiro instant√¢neo Pidgin, mostrando mensagens enviadas pelo fail2ban."/><figcaption>
            <h4>Janela de chat do mensageiro instant√¢neo Pidgin, mostrando mensagens enviadas pelo fail2ban.</h4>
        </figcaption>
</figure>


			</div>
		</article>
	</main>


<aside>
	<div>
		<div>
			<h3>LATEST POSTS</h3>
		</div>
		<div>
			<ul>
				
				<li><a href="/blog/github-pages-underline/">GitHub Pages e Nomes de Diret√≥rio Iniciados com Underline</a></li>
				
				<li><a href="/blog/unsubscribe/">Quais Empresas Respeitam o &#34;Unsubscribe&#34;?</a></li>
				
				<li><a href="/blog/input_filename-em-jq-e-yq/">input_filename das ferramentas jq e yq n√£o funcionam como esperado</a></li>
				
				<li><a href="/blog/comentarios-via-mastodon/">Adicionando Coment√°rios via Mastodon em Sites Est√°ticos</a></li>
				
				<li><a href="/blog/squash&#43;merge-no-git/">squash&#43;merge no Git</a></li>
				
			</ul>
		</div>
	</div>
</aside>


	<footer>
	<p><a href="/license">CC</a> 2023 <a href="https://gmgall.net/"><b>gmgall.net</b></a>.
	</p>
</footer>

</body>
<script src="/js/theme.js"></script>
</html>
